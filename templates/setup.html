<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Mind Map</title>
    <!-- SheetJS library for client-side Excel processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);
            /* Teal/Green gradient from logo */
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #00C9FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(0, 201, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(146, 254, 157, 0.15) 0px, transparent 50%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .header {
            background: rgba(15, 23, 42, 0.6);
            padding: 60px 30px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--glass-border);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0, 201, 255, 0.3));
            font-size: 1.2em;
            margin-top: 15px;
            font-weight: 400;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            background: rgba(15, 23, 42, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(15, 23, 42, 0.6);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: rgba(0, 201, 255, 0.1);
            border-color: var(--accent-color);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(0, 201, 255, 0.3));
        }

        .upload-text {
            font-size: 1.3em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 201, 255, 0.1);
            border-radius: 12px;
            display: none;
            border: 1px solid rgba(0, 201, 255, 0.2);
        }

        .file-info.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .file-info ul {
            list-style: none;
            padding-left: 0;
        }

        .file-info li {
            padding: 5px 0;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .process-btn {
            width: 100%;
            padding: 20px;
            background: var(--primary-gradient);
            color: #0f172a;
            border: none;
            border-radius: 16px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 30px;
            display: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 20px -10px rgba(0, 201, 255, 0.5);
        }

        .process-btn.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 30px -10px rgba(0, 201, 255, 0.6);
            filter: brightness(1.1);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            filter: grayscale(1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading {
            color: var(--text-secondary);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255, 68, 68, 0.3);
            display: none;
        }

        .error-message.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            display: none;
        }

        .success-message.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .language-selector {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-family: inherit;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .lang-btn.active {
            background: rgba(0, 201, 255, 0.15);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="language-selector">
                <button class="lang-btn active" id="langEn" onclick="switchLanguage('en')">English</button>
                <button class="lang-btn" id="langAr" onclick="switchLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
            </div>
            <div class="logo-container">
                <img src="/static/logo.png" alt="Shahid AI Logo" class="logo-img">
                <h1 id="headerTitle">Upload Mind Map</h1>
            </div>
            <p id="headerSubtitle">Upload your Excel mind map file to get started</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ðŸ“Š</div>
                    <div class="upload-text" id="uploadText">Click or drag Excel file here</div>
                    <div class="upload-hint" id="uploadHint">Supports .xlsx and .xls files</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />

                <div class="file-info" id="fileInfo">
                    <h3 id="fileInfoTitle">File Information:</h3>
                    <ul id="fileInfoList"></ul>
                </div>

                <button class="process-btn" id="processBtn" onclick="processAndUpload()">
                    <span id="processBtnText">âœ… Process & Continue</span>
                </button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #b0b0b0;" id="loadingText">Processing mind map...</p>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>

            <div
                style="margin-top: 30px; padding: 20px; background: #0f1429; border-radius: 8px; border: 1px solid #2a2f4a;">
                <h3 style="color: #8bb4ff; margin-bottom: 10px;" id="securityTitle">ðŸ”’ Security & Privacy</h3>
                <p style="color: #d0d0d0; line-height: 1.6;" id="securityText">
                    Your Excel file is processed entirely in your browser. The file never leaves your device.
                    Only the tag structure (not sensitive data) is sent to the server for AI analysis.
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentLang = 'en';
        let selectedFile = null;
        let processedData = null;

        const translations = {
            en: {
                title: "Upload Mind Map",
                subtitle: "Upload your Excel mind map file to get started",
                uploadText: "Click or drag Excel file here",
                uploadHint: "Supports .xlsx and .xls files",
                fileInfo: "File Information:",
                processBtn: "âœ… Process & Continue",
                loading: "Processing mind map...",
                securityTitle: "ðŸ”’ Security & Privacy",
                securityText: "Your Excel file is processed entirely in your browser. The file never leaves your device. Only the tag structure (not sensitive data) is sent to the server for AI analysis.",
                errorNoFile: "Please select an Excel file",
                errorInvalidFile: "Invalid file. Please select a valid Excel file (.xlsx or .xls)",
                errorProcessing: "Error processing file: ",
                successProcessing: "Mind map processed successfully!",
                successRedirecting: "Redirecting to main app..."
            },
            ar: {
                title: "Ø±ÙØ¹ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù‚Ù„",
                subtitle: "Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡",
                uploadText: "Ø§Ù†Ù‚Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§",
                uploadHint: "ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª .xlsx Ùˆ .xls",
                fileInfo: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù:",
                processBtn: "âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
                loading: "Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù‚Ù„...",
                securityTitle: "ðŸ”’ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©",
                securityText: "ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ù…ØªØµÙØ­Ùƒ. Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØºØ§Ø¯Ø± Ø¬Ù‡Ø§Ø²Ùƒ Ø£Ø¨Ø¯Ø§Ù‹. ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙ‚Ø· (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©) Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.",
                errorNoFile: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel",
                errorInvalidFile: "Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (.xlsx Ø£Ùˆ .xls)",
                errorProcessing: "Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ",
                successProcessing: "ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­!",
                successRedirecting: "Ø¬Ø§Ø±Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ..."
            }
        };

        function switchLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            // Keep header in English as requested
            // document.getElementById('headerTitle').textContent = t.title;
            // document.getElementById('headerSubtitle').textContent = t.subtitle;
            document.getElementById('uploadText').textContent = t.uploadText;
            document.getElementById('uploadHint').textContent = t.uploadHint;
            document.getElementById('fileInfoTitle').textContent = t.fileInfo;
            document.getElementById('processBtnText').textContent = t.processBtn;
            document.getElementById('loadingText').textContent = t.loading;
            document.getElementById('securityTitle').textContent = t.securityTitle;
            document.getElementById('securityText').textContent = t.securityText;

            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langAr').classList.toggle('active', lang === 'ar');
            document.body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files: files } });
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const t = translations[currentLang];

            // Validate file type
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel' // .xls
            ];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();

            if (!validExtensions.includes(fileExt) && !validTypes.includes(file.type)) {
                showError(t.errorInvalidFile);
                return;
            }

            selectedFile = file;
            displayFileInfo(file);
            document.getElementById('processBtn').classList.add('active');
            hideError();
        }

        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileInfoList = document.getElementById('fileInfoList');

            fileInfoList.innerHTML = `
                <li><strong>Name:</strong> ${file.name}</li>
                <li><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</li>
                <li><strong>Type:</strong> ${file.type || 'Excel file'}</li>
            `;
            fileInfo.classList.add('active');
        }

        function processAndUpload() {
            if (!selectedFile) {
                const t = translations[currentLang];
                showError(t.errorNoFile);
                return;
            }

            const t = translations[currentLang];
            document.getElementById('loading').classList.add('active');
            document.getElementById('processBtn').disabled = true;
            hideError();
            hideSuccess();

            // Read and process Excel file in browser (client-side)
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Convert to JSON structure (only structure, not sensitive data)
                    const mindMapData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        mindMapData[sheetName] = jsonData;
                    });

                    processedData = mindMapData;

                    // Send to server (only structure, not full data)
                    uploadMindMap(mindMapData, selectedFile.name);

                } catch (error) {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('processBtn').disabled = false;
                    showError(t.errorProcessing + error.message);
                }
            };

            reader.onerror = function () {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('processBtn').disabled = false;
                showError(t.errorProcessing + 'Failed to read file');
            };

            reader.readAsArrayBuffer(selectedFile);
        }

        async function uploadMindMap(mindMapData, filename) {
            const t = translations[currentLang];

            try {
                const response = await fetch('/api/upload-mindmap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mind_map_data: mindMapData,
                        filename: filename
                    })
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                let result;

                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // If not JSON, try to parse as text first
                    const text = await response.text();
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        // If parsing fails, it's probably an HTML error page
                        throw new Error(`Server error (${response.status}): ${response.statusText}. Please check the server logs.`);
                    }
                }

                if (result.error) {
                    // Handle structured error messages
                    let errorMessage = result.error;
                    if (result.details) {
                        errorMessage += '\n\n' + result.details;
                    }
                    if (result.solution) {
                        errorMessage += '\n\nðŸ’¡ Solution: ' + result.solution;
                    }
                    throw new Error(errorMessage);
                }

                // Success!
                document.getElementById('loading').classList.remove('active');
                showSuccess(t.successProcessing);

                // Wait a bit longer to ensure session is saved server-side
                // Then redirect to main app
                setTimeout(() => {
                    // Force a full page reload to ensure session is established
                    window.location.href = '/';
                }, 1500);

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('processBtn').disabled = false;
                showError(t.errorProcessing + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('active');
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.remove('active');
        }
    </script>
</body>

</html>